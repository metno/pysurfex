<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>pysurfex.namelist &#8212; SURFEX Python API (pysurfex)  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=536c50fe" />
    <link rel="stylesheet" type="text/css" href="../../_static/classic.css?v=1654e008" />
    
    <script src="../../_static/documentation_options.js?v=9fa44488"></script>
    <script src="../../_static/doctools.js?v=695de88e"></script>
    <script src="../../_static/sphinx_highlight.js?v=6ffebe34"></script>
    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="Related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="nav-item nav-item-0"><a href="../../index.html">SURFEX Python API (pysurfex)  documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">pysurfex.namelist</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for pysurfex.namelist</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Namelist.&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">re</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">f90nml</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">yaml</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">.binary_input</span><span class="w"> </span><span class="kn">import</span> <span class="n">InputDataFromNamelist</span>


<div class="viewcode-block" id="NamelistGenerator">
<a class="viewcode-back" href="../../index.html#pysurfex.namelist.NamelistGenerator">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">NamelistGenerator</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Namelist class.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="NamelistGenerator.__init__">
<a class="viewcode-back" href="../../index.html#pysurfex.namelist.NamelistGenerator.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">program</span><span class="p">,</span> <span class="n">nml</span><span class="p">,</span> <span class="n">macros</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">micro</span><span class="o">=</span><span class="s2">&quot;@&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Construct a base namelists class.</span>

<span class="sd">        Args:</span>
<span class="sd">            program (str): Which surfex binary you want to run</span>
<span class="sd">                           [&quot;pgd&quot;, &quot;prep&quot;, &quot;offline&quot;, &quot;soda&quot;]</span>
<span class="sd">            nml (f90nml.Namelist): A parsed fortran namelist</span>
<span class="sd">            assemble(dict): Assembly order. Defines the configuration</span>
<span class="sd">            macros(dict, optional): Macros</span>
<span class="sd">            micro(str, optional): Micro character</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">program</span> <span class="o">=</span> <span class="n">program</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nml</span> <span class="o">=</span> <span class="n">nml</span>
        <span class="k">if</span> <span class="n">macros</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">macros</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">macros</span> <span class="o">=</span> <span class="n">macros</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">micro</span> <span class="o">=</span> <span class="n">micro</span></div>


<div class="viewcode-block" id="NamelistGenerator.get_namelist">
<a class="viewcode-back" href="../../index.html#pysurfex.namelist.NamelistGenerator.get_namelist">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_namelist</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get namelist.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">bkey</span><span class="p">,</span> <span class="n">block</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nml</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">items</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">block</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">rval</span> <span class="o">=</span> <span class="n">val</span>
                <span class="n">items</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">key</span><span class="p">:</span> <span class="n">rval</span><span class="p">})</span>
                <span class="k">for</span> <span class="n">mkey</span><span class="p">,</span> <span class="n">mval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">macros</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rval</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                        <span class="n">rval</span> <span class="o">=</span> <span class="n">rval</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">micro</span><span class="si">}{</span><span class="n">mkey</span><span class="si">}{</span><span class="bp">self</span><span class="o">.</span><span class="n">micro</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">mval</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">rval</span> <span class="o">==</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">mval</span><span class="si">}</span><span class="s2">&quot;</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mval</span><span class="p">,</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">)):</span>
                            <span class="n">rval</span> <span class="o">=</span> <span class="n">mval</span>
                    <span class="n">items</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">key</span><span class="p">:</span> <span class="n">rval</span><span class="p">})</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nml</span><span class="p">[</span><span class="n">bkey</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">items</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">nml</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">input_data_from_namelist</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">input_data</span><span class="p">,</span> <span class="n">platform</span><span class="p">,</span> <span class="n">basetime</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">validtime</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">check_existence</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Construct a base namelists class to be implemented by namelist implementations.</span>

<span class="sd">        Args:</span>
<span class="sd">            input_data (dict): Input data definitions</span>
<span class="sd">            platform (SystemFilePaths): Platform specific settings</span>
<span class="sd">            basetime (as_datetime, optional): Base time</span>
<span class="sd">            validtime (as_datetime, optional): Valid time</span>
<span class="sd">            check_existence (bool, optional): Check existence of input data.</span>
<span class="sd">                                              Defaults to True</span>
<span class="sd">        Returns:</span>
<span class="sd">            data_obj (InputDataFromNamelist): Input data from namelist</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Set input data from namelist for program: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">program</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">process_macros</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>  <span class="c1"># For DICT</span>
                    <span class="n">data</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">process_macros</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>  <span class="c1"># For LIST</span>
                    <span class="n">data</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">process_macros</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">v</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">vv</span> <span class="o">=</span> <span class="n">v</span>
                    <span class="k">for</span> <span class="n">macro</span><span class="p">,</span> <span class="n">mval</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">macros</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">vv</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mval</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                            <span class="n">vv</span> <span class="o">=</span> <span class="n">vv</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">micro</span><span class="si">}{</span><span class="n">macro</span><span class="si">}{</span><span class="bp">self</span><span class="o">.</span><span class="n">micro</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">mval</span><span class="p">)</span>
                    <span class="n">data</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">vv</span>
            <span class="k">return</span> <span class="n">data</span>

        <span class="c1"># Substitute macros in binary input data</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">macros</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">input_data</span> <span class="o">=</span> <span class="n">process_macros</span><span class="p">(</span><span class="n">input_data</span><span class="p">)</span>

        <span class="n">data_obj</span> <span class="o">=</span> <span class="n">InputDataFromNamelist</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nml</span><span class="p">,</span>
            <span class="n">input_data</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">program</span><span class="p">,</span>
            <span class="n">platform</span><span class="p">,</span>
            <span class="n">basetime</span><span class="o">=</span><span class="n">basetime</span><span class="p">,</span>
            <span class="n">validtime</span><span class="o">=</span><span class="n">validtime</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">check_existence</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">data_obj</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">data_obj</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">write</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">output_file</span><span class="p">,</span> <span class="n">uppercase</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">true_repr</span><span class="o">=</span><span class="s2">&quot;.TRUE.&quot;</span><span class="p">,</span> <span class="n">false_repr</span><span class="o">=</span><span class="s2">&quot;.FALSE.&quot;</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate the namelists for &#39;target&#39;.</span>

<span class="sd">        Args:</span>
<span class="sd">            output_file (str): where to write the result</span>
<span class="sd">            (OPTIONS.nam, fort.4 or EXSEG1.nam typically)</span>
<span class="sd">            uppercase (bool, optional): Upper case namelist. Default to True</span>
<span class="sd">            true_repr (str, optional): String representation of fortran boolean true.</span>
<span class="sd">                                       Defaults to &quot;.TRUE.&quot;</span>
<span class="sd">            false_repr (str, optional): String representation of fortran boolean false.</span>
<span class="sd">                                        Defaults to &quot;.FALSE.&quot;</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nml</span><span class="o">.</span><span class="n">uppercase</span> <span class="o">=</span> <span class="n">uppercase</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nml</span><span class="o">.</span><span class="n">true_repr</span> <span class="o">=</span> <span class="n">true_repr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nml</span><span class="o">.</span><span class="n">false_repr</span> <span class="o">=</span> <span class="n">false_repr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nml</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Wrote: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">output_file</span><span class="p">)</span>

<div class="viewcode-block" id="NamelistGenerator.lower_case_namelist_dict">
<a class="viewcode-back" href="../../index.html#pysurfex.namelist.NamelistGenerator.lower_case_namelist_dict">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">lower_case_namelist_dict</span><span class="p">(</span><span class="n">dict_in</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Lower case namelist.</span>

<span class="sd">        Args:</span>
<span class="sd">            dict_in (dict): Namelist dictionary to lower case</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: Namelist in lower case</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">new_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">dict_in</span><span class="p">:</span>
            <span class="n">lower_case_dict</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">key2</span> <span class="ow">in</span> <span class="n">dict_in</span><span class="p">[</span><span class="n">key</span><span class="p">]:</span>
                <span class="n">lower_case_dict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">key2</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span> <span class="n">dict_in</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">key2</span><span class="p">]})</span>
            <span class="n">new_dict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">key</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span> <span class="n">lower_case_dict</span><span class="p">})</span>
        <span class="k">return</span> <span class="n">new_dict</span></div>
</div>



<div class="viewcode-block" id="NamelistGeneratorFromNamelistFile">
<a class="viewcode-back" href="../../index.html#pysurfex.namelist.NamelistGeneratorFromNamelistFile">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">NamelistGeneratorFromNamelistFile</span><span class="p">(</span><span class="n">NamelistGenerator</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Namelist class.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="NamelistGeneratorFromNamelistFile.__init__">
<a class="viewcode-back" href="../../index.html#pysurfex.namelist.NamelistGeneratorFromNamelistFile.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">program</span><span class="p">,</span> <span class="n">nml_file</span><span class="p">,</span> <span class="n">macros</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">micro</span><span class="o">=</span><span class="s2">&quot;@&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Construct a base namelists class from a file.</span>

<span class="sd">        Args:</span>
<span class="sd">            program (str): Which surfex binary you want to run</span>
<span class="sd">                           [&quot;pgd&quot;, &quot;prep&quot;, &quot;offline&quot;, &quot;soda&quot;]</span>
<span class="sd">            nml_file (str): Namelist file</span>
<span class="sd">            macros(dict, optional): Macros</span>
<span class="sd">            micro(str, optional): Micro character</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">parser</span> <span class="o">=</span> <span class="n">f90nml</span><span class="o">.</span><span class="n">Parser</span><span class="p">()</span>
        <span class="n">nml</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">nml_file</span><span class="p">)</span>
        <span class="n">NamelistGenerator</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">program</span><span class="p">,</span> <span class="n">nml</span><span class="p">,</span> <span class="n">macros</span><span class="o">=</span><span class="n">macros</span><span class="p">,</span> <span class="n">micro</span><span class="o">=</span><span class="n">micro</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="NamelistGeneratorAssemble">
<a class="viewcode-back" href="../../index.html#pysurfex.namelist.NamelistGeneratorAssemble">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">NamelistGeneratorAssemble</span><span class="p">(</span><span class="n">NamelistGenerator</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Namelist class.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="NamelistGeneratorAssemble.__init__">
<a class="viewcode-back" href="../../index.html#pysurfex.namelist.NamelistGeneratorAssemble.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">program</span><span class="p">,</span> <span class="n">definitions</span><span class="p">,</span> <span class="n">assemble</span><span class="p">,</span> <span class="n">macros</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">micro</span><span class="o">=</span><span class="s2">&quot;@&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Construct a base namelists class.</span>

<span class="sd">        Args:</span>
<span class="sd">            program (str): Which surfex binary you want to run</span>
<span class="sd">                           [&quot;pgd&quot;, &quot;prep&quot;, &quot;offline&quot;, &quot;soda&quot;]</span>
<span class="sd">            definitions (dict): Namelist definitions</span>
<span class="sd">            assemble(dict): Assembly order. Defines the configuration</span>
<span class="sd">            macros(dict, optional): Macros</span>
<span class="sd">            micro(str, optional): Micro character</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nldict</span> <span class="o">=</span> <span class="n">definitions</span>
        <span class="k">if</span> <span class="n">macros</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">macros</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">macros</span> <span class="o">=</span> <span class="n">macros</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assemble</span> <span class="o">=</span> <span class="n">assemble</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Namelist blocks for program </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">program</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">assemble</span><span class="p">)</span>
        <span class="n">nlres</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assemble_namelist</span><span class="p">(</span><span class="n">program</span><span class="p">)</span>
        <span class="n">nml</span> <span class="o">=</span> <span class="n">f90nml</span><span class="o">.</span><span class="n">Namelist</span><span class="p">(</span><span class="n">nlres</span><span class="p">)</span>
        <span class="n">NamelistGenerator</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">program</span><span class="p">,</span> <span class="n">nml</span><span class="p">,</span> <span class="n">macros</span><span class="o">=</span><span class="n">macros</span><span class="p">,</span> <span class="n">micro</span><span class="o">=</span><span class="n">micro</span><span class="p">)</span></div>


<div class="viewcode-block" id="NamelistGeneratorAssemble.assemble_namelist">
<a class="viewcode-back" href="../../index.html#pysurfex.namelist.NamelistGeneratorAssemble.assemble_namelist">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">assemble_namelist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">program</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate the namelists for &#39;target&#39;.</span>

<span class="sd">        Args:</span>
<span class="sd">            program (str): Which surfex binary you want to run</span>
<span class="sd">                           [&quot;pgd&quot;, &quot;prep&quot;, &quot;offline&quot;, &quot;soda&quot;]</span>

<span class="sd">        Raises:</span>
<span class="sd">            KeyError: Key not found</span>

<span class="sd">        Returns:</span>
<span class="sd">            nlres (dict): Assembled namelist</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Read namelist file with all the categories</span>

        <span class="c1"># Check target is valid</span>
        <span class="n">cndict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assemble</span><span class="p">[</span><span class="n">program</span><span class="p">]</span>
        <span class="n">nldict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nldict</span>

        <span class="c1"># Start with empty result dictionary</span>
        <span class="n">nlres</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Assemble the target namelists based on the given category order</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">flatten_list</span><span class="p">(</span><span class="n">cndict</span><span class="p">):</span>
            <span class="n">catg</span> <span class="o">=</span> <span class="n">item</span>
            <span class="c1"># variable substitution removed at this level (may be resurrected)</span>
            <span class="c1"># assemble namelists for this category</span>
            <span class="k">if</span> <span class="n">catg</span> <span class="ow">in</span> <span class="n">nldict</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">nl</span> <span class="ow">in</span> <span class="n">nldict</span><span class="p">[</span><span class="n">catg</span><span class="p">]:</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;nl=</span><span class="si">%s</span><span class="s2"> catg=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">nl</span><span class="p">,</span> <span class="n">catg</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">nl</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">nlres</span><span class="p">:</span>
                        <span class="c1"># create the result namelist dict</span>
                        <span class="n">nlres</span><span class="p">[</span><span class="n">nl</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="k">if</span> <span class="n">catg</span> <span class="o">==</span> <span class="s2">&quot;rm{&quot;</span> <span class="o">+</span> <span class="n">nl</span> <span class="o">+</span> <span class="s2">&quot;}&quot;</span><span class="p">:</span>
                        <span class="c1"># clear/remove the given namelist (but not used for now)</span>
                        <span class="n">nlres</span><span class="p">[</span><span class="n">nl</span><span class="p">]</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">nldict</span><span class="p">[</span><span class="n">catg</span><span class="p">][</span><span class="n">nl</span><span class="p">]:</span>
                            <span class="n">val</span> <span class="o">=</span> <span class="n">nldict</span><span class="p">[</span><span class="n">catg</span><span class="p">][</span><span class="n">nl</span><span class="p">][</span><span class="n">key</span><span class="p">]</span>
                            <span class="n">finval</span> <span class="o">=</span> <span class="n">val</span>
                            <span class="c1"># Replace ${var-def} with value from config, possibly</span>
                            <span class="c1"># macro-expanded. For now assumes only one subst. per line,</span>
                            <span class="c1"># could be generalized if needed</span>
                            <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">finval</span><span class="p">)</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;$&quot;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span>
                                    <span class="sa">r</span><span class="s2">&quot;^([^\$]*)\$\{([\w\#]+)\-?([^}]*)\}(.*)&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
                                <span class="p">)</span>
                                <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
                                    <span class="n">pre</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                                    <span class="n">nam</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
                                    <span class="n">defval</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
                                    <span class="n">post</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
                                    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;macros=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">macros</span><span class="p">)</span>
                                    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;look for nam=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">nam</span><span class="p">)</span>
                                    <span class="k">try</span><span class="p">:</span>
                                        <span class="n">repval</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">macros</span><span class="p">[</span><span class="n">nam</span><span class="p">]</span>
                                    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                                        <span class="n">repval</span> <span class="o">=</span> <span class="kc">None</span>
                                    <span class="k">if</span> <span class="n">repval</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                                        <span class="k">if</span> <span class="n">defval</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                                            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                                                <span class="s2">&quot;Using default value </span><span class="si">%s</span><span class="s2"> for &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span>
                                                <span class="n">defval</span><span class="p">,</span>
                                                <span class="n">nam</span><span class="p">,</span>
                                            <span class="p">)</span>
                                            <span class="n">repval</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_num</span><span class="p">(</span><span class="n">defval</span><span class="p">)</span>
                                        <span class="k">else</span><span class="p">:</span>
                                            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;No value found for: &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">nam</span><span class="p">)</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                                            <span class="s2">&quot;Replaced </span><span class="si">%s</span><span class="s2"> with: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">nam</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">repval</span><span class="p">)</span>
                                        <span class="p">)</span>
                                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">repval</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                                        <span class="n">finval</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">pre</span><span class="p">)</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">repval</span><span class="p">)</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">post</span><span class="p">)</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="n">finval</span> <span class="o">=</span> <span class="n">repval</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
                            <span class="n">nlres</span><span class="p">[</span><span class="n">nl</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">finval</span>
                            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;nl=</span><span class="si">%s</span><span class="s2"> key=</span><span class="si">%s</span><span class="s2">, finval=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">nl</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">finval</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Category </span><span class="si">%s</span><span class="s2"> not found in definitions&quot;</span><span class="p">,</span> <span class="n">catg</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">nlres</span></div>


<div class="viewcode-block" id="NamelistGeneratorAssemble.flatten_list">
<a class="viewcode-back" href="../../index.html#pysurfex.namelist.NamelistGeneratorAssemble.flatten_list">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">flatten_list</span><span class="p">(</span><span class="n">li</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Recursively flatten a list of lists (of lists).&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">li</span> <span class="o">==</span> <span class="p">[]:</span>
            <span class="k">return</span> <span class="n">li</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">li</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">NamelistGeneratorAssemble</span><span class="o">.</span><span class="n">flatten_list</span><span class="p">(</span>
                <span class="n">li</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="p">)</span> <span class="o">+</span> <span class="n">NamelistGeneratorAssemble</span><span class="o">.</span><span class="n">flatten_list</span><span class="p">(</span><span class="n">li</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
        <span class="k">return</span> <span class="n">li</span><span class="p">[:</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">NamelistGeneratorAssemble</span><span class="o">.</span><span class="n">flatten_list</span><span class="p">(</span><span class="n">li</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span></div>


<div class="viewcode-block" id="NamelistGeneratorAssemble.find_num">
<a class="viewcode-back" href="../../index.html#pysurfex.namelist.NamelistGeneratorAssemble.find_num">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">find_num</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Purpose: un-quote numbers.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">i</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">i</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">f</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">s</span></div>
</div>



<div class="viewcode-block" id="NamelistGeneratorAssembleFromFiles">
<a class="viewcode-back" href="../../index.html#pysurfex.namelist.NamelistGeneratorAssembleFromFiles">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">NamelistGeneratorAssembleFromFiles</span><span class="p">(</span><span class="n">NamelistGeneratorAssemble</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Namelist class.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="NamelistGeneratorAssembleFromFiles.__init__">
<a class="viewcode-back" href="../../index.html#pysurfex.namelist.NamelistGeneratorAssembleFromFiles.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">program</span><span class="p">,</span> <span class="n">definitions</span><span class="p">,</span> <span class="n">assemble</span><span class="p">,</span> <span class="n">macros</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">micro</span><span class="o">=</span><span class="s2">&quot;@&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Construct a base namelists class.</span>

<span class="sd">        Args:</span>
<span class="sd">            program (str): Which surfex binary you want to run</span>
<span class="sd">                           [&quot;pgd&quot;, &quot;prep&quot;, &quot;offline&quot;, &quot;soda&quot;]</span>
<span class="sd">            definitions (str): Namelist definitions</span>
<span class="sd">            assemble(str)): Assembly order. Defines the configuration</span>
<span class="sd">            macros(dict, optional): Macros</span>
<span class="sd">            micro(str, optional): Micro character</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">definitions</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file_handler</span><span class="p">:</span>
            <span class="n">definitions</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">file_handler</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">assemble</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file_handler</span><span class="p">:</span>
            <span class="n">assemble</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">file_handler</span><span class="p">)</span>
        <span class="n">NamelistGeneratorAssemble</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">program</span><span class="p">,</span> <span class="n">definitions</span><span class="p">,</span> <span class="n">assemble</span><span class="p">,</span> <span class="n">macros</span><span class="o">=</span><span class="n">macros</span><span class="p">,</span> <span class="n">micro</span><span class="o">=</span><span class="n">micro</span>
        <span class="p">)</span></div>
</div>

</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="Related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="nav-item nav-item-0"><a href="../../index.html">SURFEX Python API (pysurfex)  documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">pysurfex.namelist</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
    &#169; Copyright 2020, Trygve Aspelien.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 9.1.0.
    </div>
  </body>
</html>